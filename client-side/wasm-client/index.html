<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Leaflet GeoJSON Filter on View</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>

<body>
    <div id="map" style="height: 100vh;"></div>

    <script type="module">
    const map = L.map('map').setView([40, -100], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18
    }).addTo(map);

    let geojsonLayer = null;
    window.lastFilterTime = 0;

    const worker = new Worker("windowquery_worker.js");

    worker.onmessage = function (e) {
        const { type, geojson, filterTime, error } = e.data;

        if (type === "ready") {
            updateVisibleFeatures();
        }

        if (type === "error") {
            console.error("Worker error:", error);
        }

        if (type === "result") {
            window.lastFilterTime = filterTime;

            if (geojsonLayer) {
                geojsonLayer.remove();
            }

            geojsonLayer = L.geoJSON(geojson).addTo(map);
        }
    };

    function updateVisibleFeatures() {
        const bounds = map.getBounds();

        worker.postMessage({
            west: bounds.getWest(),
            south: bounds.getSouth(),
            east: bounds.getEast(),
            north: bounds.getNorth(),
            zoom: map.getZoom()
        });
    }

    map.on('moveend zoomend', updateVisibleFeatures);

    updateVisibleFeatures();

    // Expose functions for Selenium or external JS
    window.setMapView = function (bounds, zoom) {
        map.setView(map.getCenter(), zoom); // apply zoom
        map.fitBounds(bounds);              // apply bounding box
    };

    window.getLastFilterTime = function () {
        return window.lastFilterTime;
    };
</script>
</body>

</html>